/*
Deployment script for zaposlime_local

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "zaposlime_local"
:setvar DefaultFilePrefix "zaposlime_local"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering View [zaposlime].[EmployerReviewGridView]...';


GO
ALTER VIEW [zaposlime].[EmployerReviewGridView]
	AS
    WITH R AS
    (
        SELECT
            er.EmployerId,
            COUNT_BIG(*) AS TotalReviews,
            SUM(CASE
                    WHEN er.Comment IS NOT NULL AND LTRIM(RTRIM(er.Comment)) <> N'' THEN 1
                    ELSE 0
                END) AS CommentCount,
            AVG(CAST(er.Rating AS DECIMAL(10,4))) AS AvgRating
        FROM [zaposlime].[EmployerReview] er
        GROUP BY er.EmployerId
    )
    SELECT
        r.EmployerId,
        u.FirstName + N' ' + u.LastName AS EmployerFullName,
        r.TotalReviews,
        r.CommentCount,
        CAST(r.AvgRating AS DECIMAL(4,1)) AS AverageRating
    FROM R r
    INNER JOIN [identity].[AspNetUsers] u
        ON u.Id = r.EmployerId;
GO
PRINT N'Altering View [zaposlime].[JobGridView]...';


GO
ALTER VIEW [zaposlime].[JobGridView]
	AS 
	SELECT 
    j.Id,
    j.Title,
    j.Description,
    j.NumberOfWorkers,
    j.EmployerId,
    j.CreatedAt,
    u.FirstName + ' ' + u.LastName AS EmployerFullName,
    j.CityId,
    c.Name AS CityName,
    ISNULL(ar.AverageRating, 0.00) AS AverageRating
FROM [zaposlime].[Job] j
LEFT JOIN [identity].[AspNetUsers] u 
    ON u.Id = j.EmployerId
LEFT JOIN [zaposlime].[City] c 
    ON c.Id = j.CityId
LEFT JOIN (
    SELECT 
        EmployerId,
        CAST(AVG(CAST(Rating AS DECIMAL(9,4))) AS DECIMAL(5,1)) AS AverageRating
    FROM [zaposlime].[EmployerReview]
    GROUP BY EmployerId
) ar
    ON ar.EmployerId = j.EmployerId;
GO
PRINT N'Update complete.';


GO
