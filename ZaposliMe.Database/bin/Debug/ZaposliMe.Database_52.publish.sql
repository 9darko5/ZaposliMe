/*
Deployment script for sljakomat

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "sljakomat"
:setvar DefaultFilePrefix "sljakomat"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (QUERY_CAPTURE_MODE = ALL, CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367)) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE SCOPED CONFIGURATION SET MAXDOP = 0;
    END


GO
IF EXISTS (SELECT 1
           FROM   [sys].[databases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET TEMPORAL_HISTORY_RETENTION OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Rename refactoring operation with key cca5e6b1-2b95-48ef-a02e-e743df575efd is skipped, element [zaposlime].[Job].[LastModifiedBy] (SqlSimpleColumn) will not be renamed to UpdatedBy';


GO
PRINT N'Rename refactoring operation with key 09a88f76-1f4f-4f59-9fff-9797a4ece96c is skipped, element [zaposlime].[Job].[LastModifiedAt] (SqlSimpleColumn) will not be renamed to UpdatedAt';


GO
PRINT N'Rename refactoring operation with key 0e4f6d8f-e04e-41c5-9005-c5e94bba7798, 60dd8f62-b42c-437d-88a9-c46f72599567 is skipped, element [zaposlime].[Application].[Emplo] (SqlSimpleColumn) will not be renamed to EmployeeId';


GO
PRINT N'Creating Schema [identity]...';


GO
CREATE SCHEMA [identity]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating Schema [zaposlime]...';


GO
CREATE SCHEMA [zaposlime]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating Table [identity].[AspNetUserTokens]...';


GO
CREATE TABLE [identity].[AspNetUserTokens] (
    [UserId]        NVARCHAR (450) NOT NULL,
    [LoginProvider] NVARCHAR (450) NOT NULL,
    [Name]          NVARCHAR (450) NOT NULL,
    [Value]         NVARCHAR (MAX) NULL,
    CONSTRAINT [PK_AspNetUserTokens] PRIMARY KEY CLUSTERED ([UserId] ASC, [LoginProvider] ASC, [Name] ASC)
);


GO
PRINT N'Creating Table [identity].[AspNetUserLogins]...';


GO
CREATE TABLE [identity].[AspNetUserLogins] (
    [LoginProvider]       NVARCHAR (450) NOT NULL,
    [ProviderKey]         NVARCHAR (450) NOT NULL,
    [ProviderDisplayName] NVARCHAR (MAX) NULL,
    [UserId]              NVARCHAR (450) NOT NULL,
    CONSTRAINT [PK_user.AspNetUserLogins] PRIMARY KEY CLUSTERED ([LoginProvider] ASC, [ProviderKey] ASC, [UserId] ASC)
);


GO
PRINT N'Creating Table [identity].[AspNetUsers]...';


GO
CREATE TABLE [identity].[AspNetUsers] (
    [Id]                   NVARCHAR (450) NOT NULL,
    [Initials]             NVARCHAR (5)   NULL,
    [UserName]             NVARCHAR (256) NOT NULL,
    [NormalizedUserName]   NVARCHAR (256) NOT NULL,
    [Email]                NVARCHAR (256) NULL,
    [NormalizedEmail]      NVARCHAR (256) NULL,
    [EmailConfirmed]       BIT            NOT NULL,
    [PasswordHash]         NVARCHAR (MAX) NULL,
    [SecurityStamp]        NVARCHAR (MAX) NULL,
    [ConcurrencyStamp]     NVARCHAR (MAX) NULL,
    [PhoneNumber]          NVARCHAR (MAX) NULL,
    [PhoneNumberConfirmed] BIT            NOT NULL,
    [TwoFactorEnabled]     BIT            NOT NULL,
    [LockoutEnd]           DATETIME       NULL,
    [LockoutEnabled]       BIT            NOT NULL,
    [AccessFailedCount]    INT            NOT NULL,
    [FirstName]            NVARCHAR (50)  NOT NULL,
    [LastName]             NVARCHAR (50)  NOT NULL,
    [Age]                  BIGINT         NULL,
    CONSTRAINT [PK_user.AspNetUsers] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [identity].[AspNetUserRoles]...';


GO
CREATE TABLE [identity].[AspNetUserRoles] (
    [UserId] NVARCHAR (450) NOT NULL,
    [RoleId] NVARCHAR (450) NOT NULL,
    CONSTRAINT [PK_user.AspNetUserRoles] PRIMARY KEY CLUSTERED ([UserId] ASC, [RoleId] ASC)
);


GO
PRINT N'Creating Table [identity].[AspNetUserClaims]...';


GO
CREATE TABLE [identity].[AspNetUserClaims] (
    [Id]         INT            IDENTITY (1, 1) NOT NULL,
    [UserId]     NVARCHAR (450) NOT NULL,
    [ClaimType]  NVARCHAR (MAX) NULL,
    [ClaimValue] NVARCHAR (MAX) NULL,
    CONSTRAINT [PK_user.AspNetUserClaims] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [identity].[AspNetRoleClaims]...';


GO
CREATE TABLE [identity].[AspNetRoleClaims] (
    [Id]         INT            IDENTITY (1, 1) NOT NULL,
    [RoleId]     NVARCHAR (450) NOT NULL,
    [ClaimType]  NVARCHAR (MAX) NULL,
    [ClaimValue] NVARCHAR (MAX) NULL,
    CONSTRAINT [PK_AspNetRoleClaims] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [identity].[AspNetRoles]...';


GO
CREATE TABLE [identity].[AspNetRoles] (
    [Id]               NVARCHAR (450) NOT NULL,
    [Name]             NVARCHAR (256) NULL,
    [NormalizedName]   NVARCHAR (256) NULL,
    [ConcurrencyStamp] NVARCHAR (MAX) NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [zaposlime].[EmployeeReview]...';


GO
CREATE TABLE [zaposlime].[EmployeeReview] (
    [Id]         UNIQUEIDENTIFIER NOT NULL,
    [Rating]     INT              NOT NULL,
    [Comment]    NVARCHAR (MAX)   NULL,
    [EmployeeId] NVARCHAR (450)   NOT NULL,
    [CreatedBy]  UNIQUEIDENTIFIER NULL,
    [CreatedAt]  DATETIME         NULL,
    [UpdatedBy]  UNIQUEIDENTIFIER NULL,
    [UpdatedAt]  DATETIME         NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [zaposlime].[EmployerReview]...';


GO
CREATE TABLE [zaposlime].[EmployerReview] (
    [Id]         UNIQUEIDENTIFIER NOT NULL,
    [Rating]     INT              NOT NULL,
    [Comment]    NVARCHAR (MAX)   NULL,
    [EmployerId] NVARCHAR (450)   NOT NULL,
    [CreatedBy]  NVARCHAR (450)   NULL,
    [CreatedAt]  DATETIME         NULL,
    [UpdatedBy]  NVARCHAR (450)   NULL,
    [UpdatedAt]  DATETIME         NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [zaposlime].[City]...';


GO
CREATE TABLE [zaposlime].[City] (
    [Id]   UNIQUEIDENTIFIER NOT NULL,
    [Name] NVARCHAR (100)   NULL,
    [ZIP]  NVARCHAR (100)   NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [zaposlime].[Application]...';


GO
CREATE TABLE [zaposlime].[Application] (
    [Id]              UNIQUEIDENTIFIER NOT NULL,
    [EmployeeId]      NVARCHAR (450)   NOT NULL,
    [JobId]           UNIQUEIDENTIFIER NOT NULL,
    [Status]          INT              NOT NULL,
    [AppliedAt]       DATETIME         NULL,
    [StatusChangedAt] DATETIME         NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Table [zaposlime].[Job]...';


GO
CREATE TABLE [zaposlime].[Job] (
    [Id]              UNIQUEIDENTIFIER NOT NULL,
    [Title]           NVARCHAR (100)   NULL,
    [NumberOfWorkers] INT              NULL,
    [Description]     NVARCHAR (MAX)   NULL,
    [EmployerId]      NVARCHAR (450)   NOT NULL,
    [CityId]          UNIQUEIDENTIFIER NOT NULL,
    [CreatedBy]       NVARCHAR (450)   NULL,
    [CreatedAt]       DATETIME         NULL,
    [UpdatedBy]       NVARCHAR (450)   NULL,
    [UpdatedAt]       DATETIME         NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Foreign Key [identity].[FK_AspNetUserTokens_AspNetUsers_UserId]...';


GO
ALTER TABLE [identity].[AspNetUserTokens] WITH NOCHECK
    ADD CONSTRAINT [FK_AspNetUserTokens_AspNetUsers_UserId] FOREIGN KEY ([UserId]) REFERENCES [identity].[AspNetUsers] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [identity].[FK_user.AspNetUserLogins_user.AspNetUsers_UserId]...';


GO
ALTER TABLE [identity].[AspNetUserLogins] WITH NOCHECK
    ADD CONSTRAINT [FK_user.AspNetUserLogins_user.AspNetUsers_UserId] FOREIGN KEY ([UserId]) REFERENCES [identity].[AspNetUsers] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [identity].[FK_user.AspNetUserRoles_user.AspNetRoles_RoleId]...';


GO
ALTER TABLE [identity].[AspNetUserRoles] WITH NOCHECK
    ADD CONSTRAINT [FK_user.AspNetUserRoles_user.AspNetRoles_RoleId] FOREIGN KEY ([RoleId]) REFERENCES [identity].[AspNetRoles] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [identity].[FK_user.AspNetUserRoles_user.AspNetUsers_UserId]...';


GO
ALTER TABLE [identity].[AspNetUserRoles] WITH NOCHECK
    ADD CONSTRAINT [FK_user.AspNetUserRoles_user.AspNetUsers_UserId] FOREIGN KEY ([UserId]) REFERENCES [identity].[AspNetUsers] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [identity].[FK_user.AspNetUserClaims_user.AspNetUsers_UserId]...';


GO
ALTER TABLE [identity].[AspNetUserClaims] WITH NOCHECK
    ADD CONSTRAINT [FK_user.AspNetUserClaims_user.AspNetUsers_UserId] FOREIGN KEY ([UserId]) REFERENCES [identity].[AspNetUsers] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [identity].[FK_AspNetRoleClaims_AspNetRoles_RoleId]...';


GO
ALTER TABLE [identity].[AspNetRoleClaims] WITH NOCHECK
    ADD CONSTRAINT [FK_AspNetRoleClaims_AspNetRoles_RoleId] FOREIGN KEY ([RoleId]) REFERENCES [identity].[AspNetRoles] ([Id]) ON DELETE CASCADE;


GO
PRINT N'Creating Foreign Key [zaposlime].[FK_Review_Employee]...';


GO
ALTER TABLE [zaposlime].[EmployeeReview] WITH NOCHECK
    ADD CONSTRAINT [FK_Review_Employee] FOREIGN KEY ([EmployeeId]) REFERENCES [identity].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [zaposlime].[FK_Review_Employer]...';


GO
ALTER TABLE [zaposlime].[EmployerReview] WITH NOCHECK
    ADD CONSTRAINT [FK_Review_Employer] FOREIGN KEY ([EmployerId]) REFERENCES [identity].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [zaposlime].[FK_Application_Employee]...';


GO
ALTER TABLE [zaposlime].[Application] WITH NOCHECK
    ADD CONSTRAINT [FK_Application_Employee] FOREIGN KEY ([EmployeeId]) REFERENCES [identity].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [zaposlime].[FK_Application_Job]...';


GO
ALTER TABLE [zaposlime].[Application] WITH NOCHECK
    ADD CONSTRAINT [FK_Application_Job] FOREIGN KEY ([JobId]) REFERENCES [zaposlime].[Job] ([Id]);


GO
PRINT N'Creating Foreign Key [zaposlime].[FK_Job_User]...';


GO
ALTER TABLE [zaposlime].[Job] WITH NOCHECK
    ADD CONSTRAINT [FK_Job_User] FOREIGN KEY ([EmployerId]) REFERENCES [identity].[AspNetUsers] ([Id]);


GO
PRINT N'Creating Foreign Key [zaposlime].[FK_Job_City]...';


GO
ALTER TABLE [zaposlime].[Job] WITH NOCHECK
    ADD CONSTRAINT [FK_Job_City] FOREIGN KEY ([CityId]) REFERENCES [zaposlime].[City] ([Id]);


GO
PRINT N'Creating View [identity].[UserGridView]...';


GO
CREATE VIEW [identity].[UserGridView]
	AS SELECT
	u.Id,
	u.FirstName,
	u.LastName,
	u.Email,
	u.PhoneNumber,
	u.Age
	FROM [identity].[AspNetUsers] u
GO
PRINT N'Creating View [zaposlime].[EmployerReviewView]...';


GO
CREATE VIEW [zaposlime].[EmployerReviewView]
	AS SELECT 
	er.[Id],
    er.[EmployerId],
    er.[Rating],
    er.[Comment],
    er.[CreatedAt],
    er.[CreatedBy],
    u.FirstName + N' ' + u.LastName AS CreatedByFullName    
	FROM [EmployerReview] er
	LEFT JOIN [identity].[AspNetUsers] u ON u.Id = er.CreatedBy;
GO
PRINT N'Creating View [zaposlime].[EmployerReviewGridView]...';


GO
CREATE VIEW [zaposlime].[EmployerReviewGridView]
	AS
    WITH R AS
    (
        SELECT
            er.EmployerId,
            COUNT_BIG(*) AS TotalReviews,
            SUM(CASE
                    WHEN er.Comment IS NOT NULL AND LTRIM(RTRIM(er.Comment)) <> N'' THEN 1
                    ELSE 0
                END) AS CommentCount,
            AVG(CAST(er.Rating AS DECIMAL(10,4))) AS AvgRating
        FROM [zaposlime].[EmployerReview] er
        GROUP BY er.EmployerId
    )
    SELECT
        r.EmployerId,
        u.FirstName + N' ' + u.LastName AS EmployerFullName,
        r.TotalReviews,
        r.CommentCount,
        CAST(r.AvgRating AS DECIMAL(4,1)) AS AverageRating
    FROM R r
    INNER JOIN [identity].[AspNetUsers] u
        ON u.Id = r.EmployerId;
GO
PRINT N'Creating View [zaposlime].[CityView]...';


GO
CREATE VIEW [zaposlime].[CityView]
	AS SELECT 
		Id,
		Name,
		ZIP
		FROM [zaposlime].[City]
GO
PRINT N'Creating View [zaposlime].[UserApplicationView]...';


GO
CREATE VIEW [zaposlime].[UserApplicationView]
	AS SELECT  
	a.Id,
	a.EmployeeId,
	a.JobId,
	a.Status,
	j.Title AS JobTitle,
	j.Description AS JobDescription,
	u.FirstName + ' ' + u.LastName AS EmployerFullName,
	a.AppliedAt,
	j.CreatedAt AS JobCreatedAt
	FROM [zaposlime].[Application] a
	LEFT JOIN [zaposlime].[Job] j ON a.JobId = j.Id
	LEFT JOIN [identity].[AspNetUsers] u ON j.EmployerId = u.Id
GO
PRINT N'Creating View [zaposlime].[JobGridView]...';


GO
CREATE VIEW [zaposlime].[JobGridView]
	AS 
	SELECT 
    j.Id,
    j.Title,
    j.Description,
    j.NumberOfWorkers,
    j.EmployerId,
    j.CreatedAt,
    u.FirstName + ' ' + u.LastName AS EmployerFullName,
    j.CityId,
    c.Name AS CityName,
    ISNULL(ar.AverageRating, 0.00) AS EmployerRating
FROM [zaposlime].[Job] j
LEFT JOIN [identity].[AspNetUsers] u 
    ON u.Id = j.EmployerId
LEFT JOIN [zaposlime].[City] c 
    ON c.Id = j.CityId
LEFT JOIN (
    SELECT 
        EmployerId,
        CAST(AVG(CAST(Rating AS DECIMAL(9,4))) AS DECIMAL(5,1)) AS AverageRating
    FROM [zaposlime].[EmployerReview]
    GROUP BY EmployerId
) ar
    ON ar.EmployerId = j.EmployerId;
GO
PRINT N'Creating View [zaposlime].[EmployerApplicationView]...';


GO
CREATE VIEW [zaposlime].[EmployerApplicationView]
	AS SELECT  
	   a.[Id],
       a.[JobId]
      ,a.[Status]
      ,a.[AppliedAt]
	  ,j.Title AS JobTitle
	  ,j.Description AS JobDescription
      ,a.[StatusChangedAt]
	  ,j.[EmployerId]
	  ,u.FirstName + ' ' + u.LastName AS EmployeeFullName
	  ,u.PhoneNumber AS EmployeePhone
	  ,j.CreatedAt AS JobCreatedAt
  FROM [zaposlime].[Application] a
  LEFT JOIN [zaposlime].[Job] j ON J.Id = a.JobId
  LEFT JOIN [identity].[AspNetUsers] u ON a.[EmployeeId] = u.Id
GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'cca5e6b1-2b95-48ef-a02e-e743df575efd')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('cca5e6b1-2b95-48ef-a02e-e743df575efd')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '09a88f76-1f4f-4f59-9fff-9797a4ece96c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('09a88f76-1f4f-4f59-9fff-9797a4ece96c')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '0e4f6d8f-e04e-41c5-9005-c5e94bba7798')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('0e4f6d8f-e04e-41c5-9005-c5e94bba7798')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '60dd8f62-b42c-437d-88a9-c46f72599567')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('60dd8f62-b42c-437d-88a9-c46f72599567')

GO

GO
