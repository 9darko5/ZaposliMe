@page "/employer/jobs"
@using System.Net.Http.Json
@using ZaposliMe.Application.DTOs
@using ZaposliMe.Application.DTOs.Job
@using System.Net;
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<ZaposliMe.Frontend.Resources.Resources> L
@inject HttpClient Http

@attribute [Authorize(Roles = "Employer")]

<h3 class="mb-4 d-flex justify-content-between align-items-center">
    @L["AvailableJobs"]
    <button class="btn btn-success" @onclick="OpenAdd">+ @L["AddJob"]</button>
</h3>

@if (jobs == null || cities == null)
{
    <p><em>@L["Loading"]</em></p>
}
else if (!jobs.Any())
{
    <p>@L["NoJobsAvailable"]</p>
}
else
{
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
        @foreach (var job in jobs)
        {
            <div class="col d-flex justify-content-center">
                <!-- center each card in its column -->
                <div class="card job-card shadow-sm h-100 w-100">
                    <div class="card-body">
                        <h3 class="card-title">@job.Title</h3>

                        <!-- add line clamp if you want a fixed-height preview -->
                        <p class="card-text line-clamp-4">@job.Description</p>

                        <small class="text-muted">@L["Location"]: @job.CityName</small><br />
                        <small class="text-muted">@L["CreatedAt"]: @job.CreatedAt.ToShortDateString()</small>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <small class="text-muted">@L["WorkersNeeded"]: @job.NumberOfWorkers</small>
                        <div>
                            <button class="btn btn-sm btn-warning me-1" @onclick="() => OpenEdit(job)">@L["Edit"]</button>
                            <button class="btn btn-sm btn-danger" @onclick="() => OpenDelete(job)">@L["Delete"]</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

}

<!-- Modals -->
<EditJobModal Job="editingJob"
              Show="showEditModal"
              OnClose="CloseEdit"
              OnSave="HandleSave"
              Cities="cities"
              Errors="modalErrors" />

<DeleteJobModal Job="deletingJob"
                Show="showDeleteModal"
                OnClose="CloseDelete"
                OnConfirm="HandleDelete" />

@code {
    private List<JobDto>? jobs;
    private JobDto? editingJob;
    private JobDto? deletingJob;
    private List<CityDto>? cities;

    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool isAdding = false;

    // Server-side validation errors (raw) passed into EditJobModal
    private List<ValidationErrorDto>? modalErrors;

    protected override async Task OnInitializedAsync()
    {
        var citiesTask = Http.GetFromJsonAsync<List<CityDto>>("api/city/all");
        var jobsTask = Http.GetFromJsonAsync<List<JobDto>>("api/job/employer/all");
        await Task.WhenAll(citiesTask!, jobsTask!);

        cities = citiesTask!.Result?.OrderBy(c => c.Name).ToList();
        jobs = jobsTask!.Result ?? new();
    }

    private void OpenAdd()
    {
        editingJob = new JobDto(); // empty model
        isAdding = true;
        modalErrors = null;        // clear previous errors
        showEditModal = true;
    }

    private void OpenEdit(JobDto job)
    {
        editingJob = new JobDto
        {
            Id = job.Id,
            Title = job.Title,
            Description = job.Description,
            NumberOfWorkers = job.NumberOfWorkers,
            CityId = job.CityId,
            CityName = job.CityName,
            CreatedAt = job.CreatedAt
        };
        isAdding = false;
        modalErrors = null;        // clear previous errors
        showEditModal = true;
    }

    private void CloseEdit()
    {
        showEditModal = false;
        editingJob = null;
        isAdding = false;
        modalErrors = null;
    }

    private async Task HandleSave(JobDto job)
    {
        // set CityName for immediate UI
        if (cities is not null && job.CityId is Guid cid)
            job.CityName = cities.FirstOrDefault(c => c.Id == cid)?.Name;

        HttpResponseMessage response =
            isAdding
                ? await Http.PostAsJsonAsync("api/job/create", job)
                : await Http.PutAsJsonAsync("api/job/update", job);

        if (response.IsSuccessStatusCode)
        {
            if (isAdding)
            {
                jobs = await Http.GetFromJsonAsync<List<JobDto>>("api/job/employer/all") ?? new();
            }
            else
            {
                var index = jobs!.FindIndex(j => j.Id == job.Id);
                if (index >= 0) jobs[index] = job;
            }

            CloseEdit();
            return;
        }

        // 400 -> read ValidationErrorDto[] and keep modal open
        if (response.StatusCode == HttpStatusCode.BadRequest)
        {
            modalErrors = await response.Content.ReadFromJsonAsync<List<ValidationErrorDto>>() ?? new();
            StateHasChanged(); // trigger EditJobModal to push messages into its ValidationMessageStore
            return;
        }

        // Optional: handle other errors (toast/log)
    }

    private void OpenDelete(JobDto job)
    {
        deletingJob = job;
        showDeleteModal = true;
    }

    private void CloseDelete()
    {
        showDeleteModal = false;
        deletingJob = null;
    }

    private async Task HandleDelete(Guid id)
    {
        var response = await Http.DeleteAsync($"api/job/delete/{id}");
        if (response.IsSuccessStatusCode)
        {
            jobs!.RemoveAll(j => j.Id == id);
        }
        CloseDelete();
    }
}
